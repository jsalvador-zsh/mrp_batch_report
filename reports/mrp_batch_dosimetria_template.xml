<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_mrp_batch_dosimetria_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <div class="page" style="font-family: Arial, sans-serif; font-size: 11px;">

                        <!-- Encabezado Principal -->
                        <div class="row mb-3" style="border-bottom: 2px solid #333; padding-bottom: 8px;">
                            <div class="col-12 text-center">
                                <h3 style="margin: 0; color: #2c3e50; font-weight: bold;">PLAN HACCP</h3>
                                <small style="color: #7f8c8d;">CONTROL DE DOSIMETRÍA POR LOTES</small>
                                <div style="margin-top: 3px;">
                                    <small style="color: #7f8c8d; font-size: 8px;">
                                        Versión: <span t-esc="env['ir.config_parameter'].sudo().get_param('peruanita_mrp.report_version', '1.0')"/>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Información del Producto - Diseño Compacto -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <table class="table" style="width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 11px;">
                                    <tr style="background-color: #f8f9fa;">
                                        <td style="width: 15%; padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">PRODUCTO:</td>
                                        <td style="width: 35%; padding: 8px; border: 1px solid #dee2e6;"><span t-field="o.product_id"/></td>
                                        <td style="width: 15%; padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">KG NETO:</td>
                                        <td style="width: 35%; padding: 8px; border: 1px solid #dee2e6;"><span t-field="o.kg_neto"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Resumen de Producción -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <table class="table" style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 11px;">
                                    <tr style="background-color: #e9ecef;">
                                        <td style="width: 16%; padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">CANTIDAD TOTAL:</td>
                                        <td style="width: 17%; padding: 8px; border: 1px solid #dee2e6;"><span t-field="o.product_qty"/> <span t-field="o.product_uom_id"/></td>
                                        <td style="width: 17%; padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">CANTIDAD/BATCH:</td>
                                        <td style="width: 17%; padding: 8px; border: 1px solid #dee2e6;"><span t-field="o.batch_size"/> <span t-field="o.product_uom_id"/></td>
                                        <td style="width: 16%; padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">N° BATCHES:</td>
                                        <td style="width: 17%; padding: 8px; border: 1px solid #dee2e6;"><span t-field="o.batch_count"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Detalle por Batch -->
                        <t t-set="batch_data" t-value="o.get_batch_data_grouped_dosimetria()"/>

                        <t t-foreach="batch_data" t-as="batch">
                            <div class="batch-section" style="page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">

                                <!-- Header del Batch -->
                                <div class="batch-header" style="background-color: #2c3e50; color: white; padding: 6px 10px; border-radius: 3px; margin-bottom: 8px;">
                                    <strong>
                                        Batch <t t-esc="batch['numbers']"/>
                                        <t t-if="batch['is_multiple']">
                                            (<t t-esc="batch['count']"/> batches)
                                        </t>
                                        - Cantidad: <t t-esc="'%.2f' % batch['quantity']"/> kg
                                        <t t-if="batch['is_multiple']">
                                            c/u
                                        </t>
                                    </strong>
                                </div>

                                <!-- Tabla de Componentes con estructura de 1 fila por componente -->
                                <t t-set="num_batches" t-value="o.batch_count"/>
                                <t t-set="col_width_percentage" t-value="60.0 / max(num_batches, 1)"/>
                                <!-- Columnas fijas: 12% + 3% + 4% + 7% + 14% = 40%, quedando 60% para las columnas de mezcla -->
                                <table class="components-table" style="width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 12px; table-layout: fixed;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th rowspan="2" style="width: 12%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">COMPONENTE</th>
                                            <th rowspan="2" style="width: 3%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">%</th>
                                            <th rowspan="2" style="width: 4%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">KG/BATCH</th>
                                            <th rowspan="2" style="width: 7%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">LOTE</th>
                                            <th t-attf-colspan="#{num_batches}" style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 10px;">N° DE MEZCLAS REALIZADAS</th>
                                            <th rowspan="2" style="width: 14%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">OBS</th>
                                        </tr>

                                        <!-- Fila única de números (1-N según batch_count) -->
                                        <tr>
                                            <t t-foreach="range(1, num_batches + 1)" t-as="i">
                                                <th t-attf-style="border: 1px solid #ddd; padding: 2px; text-align: center; font-weight: normal; background-color: #e9ecef; font-size: 9px; width: #{col_width_percentage}%;">
                                                    <t t-esc="i"/>
                                                </th>
                                            </t>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <!-- Calcular el número total de filas para el rowspan de observaciones -->
                                        <t t-set="total_rows" t-value="len(batch['dosimetria_components']) + 1"/>
                                        <!-- +1 por la fila de mezcla materia -->

                                        <!-- Componentes de DOSIMETRÍA desglosados -->
                                        <t t-foreach="batch['dosimetria_components']" t-as="component">
                                            <tr>
                                                <td style="border: 1px solid #ddd; padding: 2px 3px; vertical-align: middle; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    <t t-esc="component['name']"/>
                                                </td>
                                                <td style="border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; font-size: 10px;">
                                                    <t t-esc="'%.2f' % component['percentage']"/>
                                                </td>
                                                <td style="border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; font-size: 10px;">
                                                    <t t-esc="'%.2f' % component['quantity']"/>
                                                </td>
                                                <td style="border: 1px solid #ddd; padding: 2px 3px; vertical-align: middle; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    <t t-esc="component.get('lote', '')"/>
                                                </td>

                                                <!-- Celdas para mezclas (dinámicas según batch_count) -->
                                                <t t-foreach="range(num_batches)" t-as="mix_num">
                                                    <td t-attf-style="border: 1px solid #ddd; padding: 0px; text-align: center; height: 16px; width: #{col_width_percentage}%;">
                                                        <!-- Espacio para check o datos -->
                                                    </td>
                                                </t>

                                                <!-- Celda de observaciones combinada (solo en la primera fila) -->
                                                <td t-if="component_index == 0" t-attf-rowspan="#{total_rows}" style="border: 1px solid #ddd; padding: 5px; vertical-align: top; font-size: 10px;">
                                                    <!-- Observaciones únicas para todo el batch -->
                                                </td>
                                            </tr>
                                        </t>

                                        <!-- Fila de MEZCLA MATERIA agrupada (siempre se muestra) -->
                                        <tr style="background-color: #fff3cd; font-weight: bold;">
                                            <td style="border: 1px solid #ddd; padding: 2px 3px; vertical-align: middle; font-size: 10px;">
                                                MEZCLA MATERIA
                                            </td>
                                            <td style="border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; font-size: 10px;">
                                                <t t-esc="'%.2f' % batch.get('total_mezcla_materia_percentage', 0)"/>
                                            </td>
                                            <td style="border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; font-size: 10px;">
                                                <t t-esc="'%.2f' % batch.get('total_mezcla_materia_kg', 0)"/>
                                            </td>
                                            <td style="border: 1px solid #ddd; padding: 2px 3px; vertical-align: middle; font-size: 10px;">
                                                <!-- Lote vacío para mezcla materia agrupada -->
                                            </td>

                                            <!-- Celdas para mezclas (dinámicas según batch_count) -->
                                            <t t-foreach="range(num_batches)" t-as="mix_num">
                                                <td t-attf-style="border: 1px solid #ddd; padding: 0px; text-align: center; height: 16px; width: #{col_width_percentage}%;">
                                                    <!-- Espacio para check o datos -->
                                                </td>
                                            </t>
                                            <!-- No incluir celda de observaciones aquí, ya está fusionada desde arriba -->
                                        </tr>

                                        <!-- Fila de Total -->
                                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                                            <td colspan="2" style="border: 1px solid #ddd; padding: 4px; text-align: right; font-size: 10px;">
                                                TOTAL KG/BATCH:
                                            </td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 10px;">
                                                <t t-esc="'%.2f' % batch['total_weight']"/>
                                            </td>
                                            <td t-attf-colspan="#{num_batches + 2}" style="border: 1px solid #ddd; padding: 4px;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </t>

                        <!-- Firmas -->
                        <div class="row mt-5">
                            <div class="col-6 text-center">
                                <div style="border-top: 1px solid #333; width: 80%; margin: 0 auto; padding-top: 8px;">
                                    <strong style="font-size: 10px; color: #2c3e50;">V°B° RESPONSABLE</strong>
                                </div>
                            </div>
                            <div class="col-6 text-center">
                                <div style="border-top: 1px solid #333; width: 80%; margin: 0 auto; padding-top: 8px;">
                                    <strong style="font-size: 10px; color: #2c3e50;">V°B° JEFE DE PRODUCCIÓN</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Pie de página -->
                        <div class="row mt-3">
                            <div class="col-12 text-center">
                                <small style="color: #7f8c8d; font-size: 8px;">
                                    Documento generado el <span t-field="o.create_date"/> |
                                    PLAN HACCP - Control de Dosimetría
                                </small>
                            </div>
                        </div>

                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
