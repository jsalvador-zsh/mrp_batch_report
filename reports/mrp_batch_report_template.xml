<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Layout minimalista solo para UTF-8 -->
    <template id="minimal_report_layout">
        <t t-call="web.basic_layout">
            <t t-raw="0"/>
        </t>
    </template>

    <template id="report_mrp_batch_document">
        <t t-call="mrp_batch_report.minimal_report_layout">
            <t t-foreach="docs" t-as="o">
                <div class="page" style="font-family: Arial, sans-serif; font-size: 10px; padding: 2mm 5mm; margin: 0;">

                        <!-- Encabezado Principal -->
                        <div style="border-bottom: 2px solid #333; padding-bottom: 3px; margin-bottom: 4px; text-align: center;">
                            <h3 style="margin: 0; padding: 0; color: #2c3e50; font-weight: bold; font-size: 14px;">PLAN HACCP</h3>
<<<<<<< HEAD
                            <small style="color: #7f8c8d; font-size: 12px;">CONTROL DE PRODUCCIÓN POR LOTES</small>
                            <div style="margin-top: 2px;">
                                <small style="font-size: 10px;">
                                    Código: <span t-esc="env['ir.config_parameter'].sudo().get_param('peruanita_mrp.report_code', '1.0')"/>
                                </small>
                                <small style="font-size: 10px;">
                                    Versión: <span t-esc="env['ir.config_parameter'].sudo().get_param('peruanita_mrp.report_version', '1.0')"/>
                                </small>
                                <small style="font-size: 10px;">
                                    Revisión: <span t-esc="env['ir.config_parameter'].sudo().get_param('peruanita_mrp.report_revision', '1.0')"/>
                                </small>
                            </div>
=======
                            <small style="color: #7f8c8d; font-size: 9px;">CONTROL DE PRODUCCIÓN POR LOTES</small>
>>>>>>> 97d8622377bbd0cea6efb2c24043995bdeb6f57a
                        </div>

                        <!-- Información del Producto - Diseño 3 Columnas -->
                        <div style="margin-bottom: 4px;">
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 6px; font-size: 10px;">
                                <tr style="background-color: #f8f9fa;">
                                    <td style="width: 12%; padding: 5px; border: 1px solid #dee2e6; font-weight: bold; vertical-align: top;">PRODUCTO:</td>
                                    <td style="width: 38%; padding: 5px; border: 1px solid #dee2e6; vertical-align: top;"><span t-field="o.product_id"/></td>
                                    <td style="width: 12%; padding: 5px; border: 1px solid #dee2e6; font-weight: bold; vertical-align: top;">KG NETO:</td>
                                    <td style="width: 13%; padding: 5px; border: 1px solid #dee2e6; vertical-align: top;"><span t-field="o.kg_neto"/></td>
                                    <td style="width: 12%; padding: 5px; border: 1px solid #dee2e6; font-weight: bold; vertical-align: top;">FECHA INICIO:</td>
                                    <td style="width: 13%; padding: 5px; border: 1px solid #dee2e6; vertical-align: top;">
                                        <span t-field="o.date_start" t-options="{'widget': 'datetime', 'format': 'dd/MM/yyyy HH:mm'}"/>
                                    </td>
                                </tr>
                                <tr style="background-color: #f8f9fa;">
                                    <td style="width: 12%; padding: 5px; border: 1px solid #dee2e6; font-weight: bold; vertical-align: top;">CLIENTE:</td>
                                    <td colspan="2" style="width: 50%; padding: 5px; border: 1px solid #dee2e6; vertical-align: top;">
                                        <t t-if="o.sale_partner_id">
                                            <span t-field="o.sale_partner_id"/>
                                        </t>
                                        <t t-elif="o.consolidated_partner_ids">
                                            <t t-foreach="o.consolidated_partner_ids" t-as="partner">
                                                <span t-esc="partner.name"/>
                                                <t t-if="not partner_last">, </t>
                                            </t>
                                        </t>
                                        <span t-if="not o.sale_partner_id and not o.consolidated_partner_ids" style="color: #999;">No asignado</span>
                                    </td>
                                    <td style="width: 12%; padding: 5px; border: 1px solid #dee2e6; font-weight: bold; vertical-align: top;">ENVASE PRIMARIO:</td>
                                    <td colspan="2" style="width: 25%; padding: 5px; border: 1px solid #dee2e6; vertical-align: top;">
                                        <span t-field="o.envase_primario"/>
                                    </td>
                                </tr>
                                <tr style="background-color: #f8f9fa;">
                                    <td style="width: 12%; padding: 5px; border: 1px solid #dee2e6; font-weight: bold; vertical-align: top;">LOTE ENVASE:</td>
                                    <td style="width: 38%; padding: 5px; border: 1px solid #dee2e6; vertical-align: top;">
                                        <span t-field="o.lote_envase"/>
                                    </td>
                                    <td style="width: 12%; padding: 5px; border: 1px solid #dee2e6; font-weight: bold; vertical-align: top;">TIPO ENVASE:</td>
                                    <td style="width: 13%; padding: 5px; border: 1px solid #dee2e6; vertical-align: top;">
                                        <span t-field="o.tipo_envase"/>
                                    </td>
                                    <td style="width: 12%; padding: 5px; border: 1px solid #dee2e6; font-weight: bold; vertical-align: top;">CÓDIGO EQUIPO:</td>
                                    <td style="width: 13%; padding: 5px; border: 1px solid #dee2e6; vertical-align: top;">
                                        <span t-field="o.codigo_equipo"/>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <!-- Resumen de Producción -->
                        <div class="row" style="margin-bottom: 8px;">
                            <div class="col-12">
                                <table class="table" style="width: 100%; border-collapse: collapse; margin-bottom: 8px; font-size: 11px;">
                                    <tr style="background-color: #e9ecef;">
                                        <td style="width: 16%; padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">CANTIDAD TOTAL:</td>
                                        <td style="width: 17%; padding: 8px; border: 1px solid #dee2e6;"><span t-field="o.product_qty"/> <span t-field="o.product_uom_id"/></td>
                                        <td style="width: 17%; padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">CANTIDAD/BATCH:</td>
                                        <td style="width: 17%; padding: 8px; border: 1px solid #dee2e6;"><span t-field="o.batch_size"/> <span t-field="o.product_uom_id"/></td>
                                        <td style="width: 16%; padding: 8px; border: 1px solid #dee2e6; font-weight: bold;">N° BATCHES:</td>
                                        <td style="width: 17%; padding: 8px; border: 1px solid #dee2e6;"><span t-field="o.batch_count"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Detalle por Batch -->
                        <t t-set="batch_data" t-value="o.get_batch_data_grouped()"/>
                        
                        <t t-foreach="batch_data" t-as="batch">
                            <div class="batch-section" style="page-break-inside: avoid; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; padding: 6px;">

                                <!-- Header del Batch -->
                                <div class="batch-header" style="background-color: #2c3e50; color: white; padding: 4px 8px; border-radius: 3px; margin-bottom: 6px;">
                                    <strong>
                                        Batch <t t-esc="batch['numbers']"/>
                                        <t t-if="batch['is_multiple']">
                                            (<t t-esc="batch['count']"/> batches)
                                        </t>
                                        - Cantidad: <t t-esc="'%.2f' % batch['quantity']"/> kg
                                        <t t-if="batch['is_multiple']">
                                            c/u
                                        </t>
                                    </strong>
                                </div>
                                
                                <!-- Tabla de Componentes con estructura de 1 fila por componente -->
                                <t t-set="num_batches" t-value="o.batch_count"/>
                                <t t-set="col_width_percentage" t-value="60.0 / max(num_batches, 1)"/>
                                <!-- Columnas fijas: 12% + 3% + 4% + 7% + 14% = 40%, quedando 60% para las columnas de mezcla -->
                                <table class="components-table" style="width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 6px; table-layout: fixed;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th rowspan="2" style="width: 12%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">MATERIA PRIMA</th>
                                            <th rowspan="2" style="width: 3%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">%</th>
                                            <th rowspan="2" style="width: 4%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">KG/BATCH</th>
                                            <th rowspan="2" style="width: 7%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">LOTE</th>
                                            <th t-attf-colspan="#{num_batches}" style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 10px;">N° DE MEZCLAS REALIZADAS</th>
                                            <th rowspan="2" style="width: 14%; border: 1px solid #ddd; padding: 3px; vertical-align: middle; text-align: center; font-size: 10px;">OBS</th>
                                        </tr>

                                        <!-- Fila única de números (1-N según batch_count) -->
                                        <tr>
                                            <t t-foreach="range(1, num_batches + 1)" t-as="i">
                                                <th t-attf-style="border: 1px solid #ddd; padding: 2px; text-align: center; font-weight: normal; background-color: #e9ecef; font-size: 9px; width: #{col_width_percentage}%;">
                                                    <t t-esc="i"/>
                                                </th>
                                            </t>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <!-- Calcular el número total de filas para el rowspan de observaciones -->
                                        <t t-set="total_rows" t-value="len(batch['components']) + 1"/>
                                        <!-- +1 por la fila de dosimetría -->

                                        <t t-foreach="batch['components']" t-as="component">
                                            <!-- Fila única del componente con N celdas según batch_count -->
                                            <tr>
                                                <td style="border: 1px solid #ddd; padding: 2px 3px; vertical-align: middle; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    <t t-esc="component['name']"/>
                                                </td>
                                                <td style="border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; font-size: 10px;">
                                                    <t t-esc="'%.2f' % component['percentage']"/>
                                                </td>
                                                <td style="border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; font-size: 10px;">
                                                    <t t-esc="'%.2f' % component['quantity']"/>
                                                </td>
                                                <td style="border: 1px solid #ddd; padding: 2px 3px; vertical-align: middle; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    <t t-esc="component.get('lote', '')"/>
                                                </td>

                                                <!-- Celdas para mezclas (dinámicas según batch_count) -->
                                                <t t-foreach="range(num_batches)" t-as="mix_num">
                                                    <td t-attf-style="border: 1px solid #ddd; padding: 0px; text-align: center; height: 16px; width: #{col_width_percentage}%;">
                                                        <!-- Espacio para check o datos -->
                                                    </td>
                                                </t>

                                                <!-- Celda de observaciones combinada (solo en la primera fila) -->
                                                <td t-if="component_index == 0" t-attf-rowspan="#{total_rows}" style="border: 1px solid #ddd; padding: 5px; vertical-align: top; font-size: 10px;">
                                                    <!-- Observaciones únicas para todo el batch -->
                                                </td>
                                            </tr>
                                        </t>

                                        <!-- Fila de Dosimetría agrupada (siempre se muestra) -->
                                        <tr style="background-color: #e3f2fd; font-weight: bold;">
                                            <td style="border: 1px solid #ddd; padding: 2px 3px; vertical-align: middle; font-size: 10px;">
                                                DOSIMETRÍA
                                            </td>
                                            <td style="border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; font-size: 10px;">
                                                <t t-esc="'%.2f' % batch.get('total_dosimetria_percentage', 0)"/>
                                            </td>
                                            <td style="border: 1px solid #ddd; padding: 2px; text-align: center; vertical-align: middle; font-size: 10px;">
                                                <t t-esc="'%.2f' % batch.get('total_dosimetria_kg', 0)"/>
                                            </td>
                                            <td style="border: 1px solid #ddd; padding: 2px 3px; vertical-align: middle; font-size: 10px;">
                                                <!-- Lote vacío para dosimetría agrupada -->
                                            </td>

                                            <!-- Celdas para mezclas (dinámicas según batch_count) -->
                                            <t t-foreach="range(num_batches)" t-as="mix_num">
                                                <td t-attf-style="border: 1px solid #ddd; padding: 0px; text-align: center; height: 16px; width: #{col_width_percentage}%;">
                                                    <!-- Espacio para check o datos -->
                                                </td>
                                            </t>
                                            <!-- No incluir celda de observaciones aquí, ya está fusionada desde arriba -->
                                        </tr>

                                        <!-- Fila de Total -->
                                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                                            <td colspan="2" style="border: 1px solid #ddd; padding: 4px; text-align: right; font-size: 10px;">
                                                TOTAL KG/BATCH:
                                            </td>
                                            <td style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 10px;">
                                                <t t-esc="'%.2f' % batch['total_weight']"/>
                                            </td>
                                            <td t-attf-colspan="#{num_batches + 2}" style="border: 1px solid #ddd; padding: 4px;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </t>

                        <!-- Firmas -->
                        <div style="margin-top: 25px; display: table; width: 100%;">
                            <div style="display: table-cell; width: 33.33%; text-align: center; vertical-align: top; padding: 0 5px;">
                                <div style="padding-top: 40px;">
                                    <div style="border-top: 1px solid #333; width: 90%; margin: 0 auto; padding-top: 6px;">
                                        <strong style="font-size: 10px; color: #2c3e50;">V°B° RESPONSABLE</strong>
                                    </div>
                                </div>
                            </div>
                            <div style="display: table-cell; width: 33.33%; text-align: center; vertical-align: top; padding: 0 5px;">
                                <div style="padding-top: 40px;">
                                    <div style="border-top: 1px solid #333; width: 90%; margin: 0 auto; padding-top: 6px;">
                                        <strong style="font-size: 10px; color: #2c3e50;">V°B° SUPERV. DE PRODUCCIÓN</strong>
                                    </div>
                                </div>
                            </div>
                            <div style="display: table-cell; width: 33.33%; text-align: center; vertical-align: top; padding: 0 5px;">
                                <div style="padding-top: 40px;">
                                    <div style="border-top: 1px solid #333; width: 90%; margin: 0 auto; padding-top: 6px;">
                                        <strong style="font-size: 10px; color: #2c3e50;">V°B° JEFE(A) DE CALIDAD Y PLANTA</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pie de página -->
                        <div class="row" style="margin-top: 8px;">
                            <div class="col-12 text-center">
<<<<<<< HEAD
                                <small style="font-size: 10px;">
=======
                                <small style="color: #7f8c8d; font-size: 8px;">
>>>>>>> 97d8622377bbd0cea6efb2c24043995bdeb6f57a
                                    Documento generado el <span t-field="o.create_date"/> |
                                    PLAN HACCP - Control de Calidad
                                </small>
                            </div>
                        </div>

                </div>
            </t>
        </t>
    </template>
</odoo>